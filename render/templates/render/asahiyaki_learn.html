<!doctype html>
<html lang="en">
<head>
    {% load static %}
    {% load custom_filters %}
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>伝統工芸品・職人</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
   
</head>
<body>
<header class="container mt-4 mb-4"> 
    <div class="row text-center justify-content-center">
        <div class="col">
            <h1 class="display-4">
                学習後の再評価ページ
            </h1>
            <div>それぞれの器に評価をつけてください</div>
            <div>ドラッグして360度回転させて、正面の画像を選択してください。</div>
            <div>正面だと思うところで止めて、保存ボタンを押してください</div>
        </div>
    </div>  
</header>

 <!-- お手本画像セクション -->
 <div class="row my-4">
    <h2 class="col-12 text-center">お手本の画像</h2>
    <div class="col-md-4 text-center">
        <h3>A評価</h3>
        <img src="{% static "asahiyaki/sample/01.png" %}" class="img-fluid">
        <img src="{% static "asahiyaki/sample/01.png" %}" class="img-fluid">
    </div>
    <div class="col-md-4 text-center">
        <h3>B評価</h3>
        <img src="{% static "asahiyaki/sample/01.png" %}" class="img-fluid">
        <img src="{% static "asahiyaki/sample/01.png" %}" class="img-fluid">
    </div>
    <div class="col-md-4 text-center">
        <h3>C評価</h3>
        <img src="{% static "asahiyaki/sample/01.png" %}" class="img-fluid">
        <img src="{% static "asahiyaki/sample/01.png" %}" class="img-fluid">
    </div>
</div>

<main class="container">
    <h2 class="col-12 text-center">再評価してください</h2>
    <div class="row" mb-4>  <!-- 行を追加 -->
        {% for asahiyaki in asahiyakis %}
        <div class="col-md-4">  <!-- 3列配置のためのカラム -->
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">{{ asahiyaki.name }}</h5>
                    <!-- ABC評価の選択 -->
                    <div class="mb-3">
                        <label class="form-label">ABC評価:</label>
                        <div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="evaluation-{{ forloop.counter }}" id="evaluation-A-{{ forloop.counter }}" value="A">
                                <label class="form-check-label" for="evaluation-A-{{ forloop.counter }}">
                                    A
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="evaluation-{{ forloop.counter }}" id="evaluation-B-{{ forloop.counter }}" value="B">
                                <label class="form-check-label" for="evaluation-B-{{ forloop.counter }}">
                                    B
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="evaluation-{{ forloop.counter }}" id="evaluation-C-{{ forloop.counter }}" value="C">
                                <label class="form-check-label" for="evaluation-C-{{ forloop.counter }}">
                                    C
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="container">
                        <div class="cloudimage-360" id="gurkha-suv-{{ forloop.counter }}"
                             data-folder="{% static asahiyaki.image_path %}cropped/"
                             data-image-list-x='[
                                "01.png",
                                "02.png",
                                "03.png",
                                "04.png",
                                "05.png",
                                "06.png",
                                "07.png",
                                "08.png",
                                "09.png",
                                "10.png",
                                "11.png",
                                "12.png",
                                "13.png",
                                "14.png",
                                "15.png",
                                "16.png",
                                "17.png",
                                "18.png",
                                "19.png",
                                "20.png",
                                "21.png",
                                "22.png",
                                "23.png",
                                "24.png"
                             ]'
                             data-amount-x="24">
                        </div>
                    </div>

                    <!-- 画像固定用のチェックボックス -->
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="fix-image-{{ forloop.counter }}">
                        <label class="form-check-label" for="fix-image-{{ forloop.counter }}">
                            正面画像として選択
                        </label>
                    </div>
                    
                    <!-- 選択保存フォーム -->
                    <div class="container">
                        <form class="selectionForm" data-form-id="{{ forloop.counter }}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="selected_image" id="selected_image_{{ forloop.counter }}" value="">
                            <input type="hidden" id="evaluation-{{forloop.counter}}" name="evaluation" value="">
                            <input type="hidden" name="asahiyaki" value="{{ asahiyaki.id }}">
                            <button type="submit" class="btn btn-primary mt-3">上記の選択を保存</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
</main >

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script src="{% static 'js/index.js' %}"></script>
<!--
  Powered by Scaleflex team. All rights reserved.
  JS Cloudimage 360 View is provided under the MIT License
-->
<script src="https://scaleflex.cloudimg.io/v7/plugins/js-cloudimage-360-view/latest/js-cloudimage-360-view.min.js?func=proxy"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const forms = document.querySelectorAll('.selectionForm');
    
        forms.forEach(function(form) {
            form.addEventListener('submit', function(event) {
                event.preventDefault(); // 通常のフォーム送信を防ぎます。
                const submitButton = form.querySelector('button[type="submit"]'); 
                const formId = form.getAttribute('data-form-id');
                const checkbox = document.getElementById(`fix-image-${formId}`);
                const viewer = document.getElementById('gurkha-suv-' + formId);
                const images = JSON.parse(viewer.getAttribute('data-image-list-x'));
                const selectedImageIndex = window.CI360.getActiveIndexByID('gurkha-suv-' + formId, 'x');
                const selectedImage = images[selectedImageIndex];
                const evaluationRadios = document.querySelectorAll(`input[name="evaluation-${formId}"]`);
                let selectedEvaluation = '';

                // ラジオボタンの選択値を取得
                evaluationRadios.forEach(radio => {
                    if (radio.checked) {
                        selectedEvaluation = radio.value;
                    }
                });

                // CSRFトークンを取得
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                if (selectedEvaluation === '') {
                    alert('ABC評価を選択してください。');
                    return;
                }

                if (!checkbox.checked) {
                    alert('正面画像を選択してください。');
                    return;
                }
    
                // データの準備
                const postData = {
                    asahiyaki: form.elements['asahiyaki'].value, // asahiyaki IDを適切に取得
                    evaluation: selectedEvaluation
                };
    
                // チェックボックスがチェックされていれば画像情報を含める
                if (checkbox.checked) {
                    postData.selected_image = selectedImage;
                }
    
                fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify(postData)
                }).then(response => response.json())
                  .then(data => {
                      console.log('Success:', data);
                      submitButton.textContent = '保存済み'; // ボタンのテキストを更新
                      submitButton.classList.add('btn-success'); // 成功時のスタイル変更
                      
                  })
                  .catch((error) => {
                      console.error('Error:', error);
                      alert('エラーが発生しました: ' + error.message);
                  });
            });
        });
    });
    
    </script>
    

</body>
</html>
